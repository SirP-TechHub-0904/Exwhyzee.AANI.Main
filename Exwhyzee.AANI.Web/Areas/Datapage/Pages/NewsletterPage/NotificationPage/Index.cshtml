@page
@model Exwhyzee.AANI.Web.Areas.Datapage.Pages.NewsletterPage.NotificationPage.IndexModel

@{
    ViewData["Title"] = "Send Notification";
}
<div class="card card-default">
    <div class="card-header">
        <h3 class="card-title">Send Notification</h3>
    </div>

    @await Html.PartialAsync("_MessageNotice")

    <div class="card-body">
        <form method="post" id="notificationForm">
            @Html.AntiForgeryToken()

            <input type="hidden" name="SelectedParticipantIdsJson" id="SelectedParticipantIdsJson" />

            <div class="form-group">
                <label>Message Type</label>
                <select asp-for="MessageType" asp-items="Model.MessageTypeList" class="form-control" id="messageTypeSelect"></select>
            </div>

            <div id="templateSection" style="display:none;">
                <div class="form-group">
                    <label>Template</label>
                    <select asp-for="SelectedTemplateId" asp-items="Model.TemplateList" class="form-control" id="templateSelect"></select>
                </div>
            </div>

            <div id="subjectSection" style="display:none;">
                <div class="form-group">
                    <label>Subject</label>
                    <input asp-for="Subject" class="form-control" />
                </div>
            </div>

            <div id="editorSection" style="display:none;">
                <div class="form-group">
                    <label>Message Body - <span>{{fullname}}</span> confirm the body has this.</label>
                    <textarea asp-for="Body" class="form-control" id="messageBodyEditor"></textarea>
                </div>
            </div>

            <div class="form-group">
                <label>Manual Recipients (paste here) - format: (fullname,email,phone)(fullname,email,phone) or one per line</label>
                <textarea asp-for="ManualRecipients" class="form-control" rows="5"></textarea>
                <small class="form-text text-muted">You can also use lines like: John Doe,john@example.com,+2348012345678</small>
            </div>

            <hr />

            <div class="form-group">
                <label>Recipient Source</label>
                <select asp-for="RecipientSource" class="form-control" id="recipientSource">
                    <option value="">-- Select --</option>
                    <option value="all">All</option>
                    <option value="chapter">Chapter</option>
                    <option value="sec">SEC</option>
                </select>
            </div>

            <div class="form-row" id="chapterSelectRow" style="display:none;">
                <div class="col-md-6">
                    <label>Chapter</label>
                    <select asp-for="SelectedChapterId" asp-items="Model.ChapterList" class="form-control" id="chapterSelect">
                        <option value="">Choose Chapter</option>
                    </select>
                </div>
            </div>
            <div class="form-row" id="secSelectRow" style="display:none;">
                <div class="col-md-6">
                    <label>SEC</label>
                    <select asp-for="SelectedSecId" asp-items="Model.SecList" class="form-control" id="secSelect">
                        <option value="">Choose SEC</option>
                    </select>
                </div>
            </div>

            <!-- Top selected count -->
            <div id="selectedCountTop" class="mb-2" style="display:none;">
                <strong>Selected participants:</strong> <span id="selectedCountTopValue">0</span>
            </div>

            <div id="participantsSection" style="display:none; margin-top:20px;">
                <style>
                    .selected-row {
                        background: #f4fbff;
                    }

                    .sn-cell {
                        width: 60px;
                        text-align: center;
                    }

                    .checkbox-cell {
                        width: 60px;
                        text-align: center;
                    }
                </style>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th class="sn-cell">S/N</th>
                                <th class="checkbox-cell"><input type="checkbox" id="selectAll" /></th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>SEC</th>
                                <th>Chapter</th>
                            </tr>
                        </thead>
                        <tbody id="participantsBody">
                            <!-- rows loaded by AJAX -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Bottom selected count -->
            <div id="selectedCountBottom" class="mt-2 mb-3" style="display:none;">
                <strong>Total selected:</strong> <span id="selectedCountBottomValue">0</span>
            </div>

            <div class="form-group mt-3">
                <button type="submit" class="btn btn-primary">Queue Messages</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.18/summernote-bs4.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.18/summernote-bs4.min.css" />

    <script>
        $(function () {
            function showHideSections() {
                var mt = $('#messageTypeSelect').val();
                if (mt === 'Email') {
                    $('#templateSection').show();
                    $('#subjectSection').show();
                    $('#editorSection').show();
                    if (!$('#messageBodyEditor').data('summernote')) {
                        $('#messageBodyEditor').summernote({ height: 200 });
                    }
                } else if (mt === 'Sms' || mt === 'Whatsapp') {
                    $('#templateSection').show();
                    $('#subjectSection').hide();
                    $('#editorSection').show();
                    if ($('#messageBodyEditor').data('summernote')) {
                        $('#messageBodyEditor').summernote('destroy');
                    }
                } else {
                    $('#templateSection').hide();
                    $('#subjectSection').hide();
                    $('#editorSection').hide();
                }
            }

            $('#messageTypeSelect').change(function () {
                showHideSections();
                // load templates for the selected type
                var type = $(this).val();
                $('#templateSelect').html('<option>Loading...</option>');
                $.get('@Url.Page("Index", "Templates")', { messageType: type }, function (data) {
                    var html = '<option value="">-- Select Template --</option>';
                    $.each(data, function (i, t) {
                        html += '<option value="' + t.id + '">' + t.name + '</option>';
                    });
                    $('#templateSelect').html(html);
                });
            });

            $('#templateSelect').change(function () {
                var id = $(this).val();
                if (!id) return;
                $.get('@Url.Page("Index", "TemplateLoad")', { id: id }, function (data) {
                    if (data.subject) {
                        $('input[name="Subject"]').val(data.subject);
                    }
                    $('textarea[name="Body"]').val(data.body);
                    if ($('#messageBodyEditor').data('summernote')) {
                        $('#messageBodyEditor').summernote('code', data.body);
                    }
                });
            });

            $('#recipientSource').change(function () {
                var v = $(this).val();
                $('#participantsSection').hide();
                $('#chapterSelectRow').hide();
                $('#secSelectRow').hide();
                $('#selectedCountTop').hide();
                $('#selectedCountBottom').hide();

                if (v === 'all') {
                    // prefer server-side expansion for all (we still show a preview)
                    $('#participantsSection').show();
                    loadParticipants({ source: 'all', preview: true });
                } else if (v === 'chapter') {
                    $('#chapterSelectRow').show();
                } else if (v === 'sec') {
                    $('#secSelectRow').show();
                }
            });

            $('#chapterSelect').change(function () {
                var id = $(this).val();
                if (!id) return;
                loadParticipants({ source: 'chapter', chapterId: id });
            });

            $('#secSelect').change(function () {
                var id = $(this).val();
                if (!id) return;
                loadParticipants({ source: 'sec', secId: id });
            });

            // update S/N values and selected counts
            function refreshSnAndCounts() {
                $('#participantsBody tr').each(function (index) {
                    $(this).find('.sn-cell').text(index + 1);
                });

                var total = $('.selectItem:checked').length;
                if ($('#participantsBody tr').length > 0) {
                    $('#selectedCountTop').show();
                    $('#selectedCountBottom').show();
                } else {
                    $('#selectedCountTop').hide();
                    $('#selectedCountBottom').hide();
                }
                $('#selectedCountTopValue').text(total);
                $('#selectedCountBottomValue').text(total);
            }

            function loadParticipants(query) {
                $('#participantsSection').show();
                $('#participantsBody').html('<tr><td colspan="7">Loading...</td></tr>');
                $.get('@Url.Page("Index", "Participants")', query, function (data) {
                    var html = '';
                    $.each(data, function (i, p) {
                        html += '<tr class="participant-row selected-row">';
                        html += '<td class="sn-cell">' + (i + 1) + '</td>';
                        html += '<td class="checkbox-cell"><input type="checkbox" class="selectItem" value="' + p.id + '" checked /></td>';
                        html += '<td>' + p.fullname + '</td>';
                        html += '<td>' + (p.email || '') + '</td>';
                        html += '<td>' + (p.phone || '') + '</td>';
                        html += '<td>' + (p.sec || '') + '</td>';
                        html += '<td>' + (p.chapter || '') + '</td>';
                        html += '</tr>';
                    });
                    $('#participantsBody').html(html);

                    // set select-all checked state and counts
                    $('#selectAll').prop('checked', $('.selectItem').length && $('.selectItem:checked').length === $('.selectItem').length);
                    $('.selectItem').each(function () {
                        $(this).closest('tr').toggleClass('selected-row', $(this).is(':checked'));
                    });
                    refreshSnAndCounts();
                });
            }

            // select all logic and coloring
            $(document).on('change', '#selectAll', function () {
                const checked = $(this).is(':checked');
                $('.selectItem').prop('checked', checked).trigger('change');
            });

            $(document).on('change', '.selectItem', function () {
                var $tr = $(this).closest('tr');
                $tr.toggleClass('selected-row', $(this).is(':checked'));
                $('#selectAll').prop('checked', $('.selectItem').length && $('.selectItem:checked').length === $('.selectItem').length);
                refreshSnAndCounts();
            });

            // before submit, collect checked participant ids into hidden JSON field
            $('#notificationForm').on('submit', function () {
                var ids = [];
                $('.selectItem:checked').each(function () {
                    ids.push($(this).val());
                });
                $('#SelectedParticipantIdsJson').val(JSON.stringify(ids));
                // allow form to submit
            });
        });
    </script>
}